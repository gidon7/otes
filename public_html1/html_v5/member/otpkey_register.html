<style type="text/css">
* { box-sizing:border-box; font-family: "Malgun Gothic", "맑은 고딕", Arial, Dotum, Gulim; }
html, body, #container { background-color:#f8f8f8; width:100%; height:auto; text-align:center; }
#container h3 { padding-top:80px; margin:10px auto; font-size:24px; }

#auth2, #key_area { width:400px; margin:0 auto; background-color:#f5f5f5; border:1px solid #dedede; border-radius:4px; text-align:center; }
#auth2 #description, #key_area #description2 { padding:20px 0 10px; }

#auth2 #auth2_box, #key_area #key_box { width:300px; margin:0 auto; }
#auth2 #auth2_box div, #key_area #key_box div { width:100%; display:block; margin:0 auto; }
#auth2 #auth2_box div input { width:70%; text-align:left; margin-top:10px; padding:5px 10px; height:42px; font-size:20px;}
#key_area #key_box button[type=submit], .logout { width:100%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; padding:10px; margin:30px 0; cursor:pointer; }
#key_area #key_box button[type=submit]:disabled { background-color:#BFBFBF; border-color:#BFBFBF; cursor:auto; }
#auth2 #auth2_box button[type=button]:disabled { background-color:#BFBFBF; border-color:#BFBFBF; cursor:auto; }
#auth2 #auth2_box button[type=button] { width:100%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; padding:10px; margin:30px 0; cursor:pointer;}
#auth2 #auth2_box div button[type=button] { width:25%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; text-align:center; margin:10px 0 0 0; padding:7px 10px 5px; height:42px; cursor:pointer;}
span { display:inline-block; padding-top:10px; font-size:16px; align-content:center; }
#timer { color:red; }
#alert_area, #alert_area2 {position:absolute;width:500px;z-index:999999; font-size:14px;margin:0;}

.alert {background-color:#dedede; color:#000000; border:1px solid #000000; opacity:0.9; font-weight:bold; border-radius:5px; max-width:400px; padding:5px 10px; margin-left:10px; margin-bottom:5px;box-sizing:border-box;}
.alert_green {background-color:#ecffd5; color:#55aa55; border:1px solid #55aa55;}
.alert_red {background-color:#f9dfd0; color:#cc0000; border:1px solid #cc0000;}

#key_area { display:none; }
.logout { background-color:#BFBFBF !important; border-color:#BFBFBF !important; color:#111 !important; margin-top:0 !important;}
button.gray { background-color:#BFBFBF !important;border-color:#666 !important; }

#wrap_alert, #wrap_alert2{ min-height:50px;display:none;margin-bottom:20px !important; }
#wrap_alert .alert, #wrap_alert2 .alert { margin-bottom:20px;font-size:14px; }

#key {font-size:23px;font-weight:bold;margin:20px 0 10px 0 !important;}
</style>

<div id="container">
<h3>OTP 키 등록</h3>
<div id="container2">
    <div id="auth2">
        <div id="description">인증번호를 입력해주세요.</div>
        <div id="auth2_box">
            <form name="form1" method="get" target="sysfrm">
                <div>
                    <input tabindex="1" type="text" name="auth_no" id="auth_no" style="margin-top: -4px;" placeholder="인증번호" maxlength="6">
                    <button tabindex="2" type="button" onclick="sendAuthNo()">재발송</button>
                    <br/>
                    <span>남은시간 : <span id="timer">00:00</span></span>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <a href="#" onclick="goAnotherAuth2('E');" style="text-decoration: underline;">이메일로 인증하기</a>&nbsp;&nbsp;&nbsp; <a href="#" onclick="goAnotherAuth2('S');" style="text-decoration: underline;">SMS로 인증하기</a>&nbsp;
                </div>
                <button tabindex="3" id="auth2_verify" type="button" style="margin-top: 0px; margin-bottom: 30px" onclick="verifyAuthNo()">인증번호확인</button>
                <button tabindex="4" class="logout" type="button" onclick="location.href='logout.jsp'">취소하고 로그인페이지로 이동하기</button>

            </form>

            <div id="wrap_alert">
                <div class="alert">내용을 불러오고 있습니다...</div>
            </div>
        </div>
    </div>
</div>
<div id="key_area">
    <div id="key_box">
        <form name="form2" method="post" target="sysfrm">
            <input type="hidden" name="returl" value="{{returl}}">
            <input type="hidden" name="domain" value="{{domain}}">
            <input type="hidden" name="session_id" value="{{session_id}}">
            <input type="hidden" name="mode" value="insert">
            <input type="hidden" name="otp_key" value=""/>

            <div id="key"></div>
            <div id="QRcode"><img id="QRUrl" alt="QR바코드"/></div>
            <button type="submit">OTP 키 등록하기</button>
            <button tabindex="4" class="logout" type="button" onclick="location.href='logout.jsp'">취소하고 로그인페이지로 이동하기</button>
        </form>
        {{form_script}}

        <div id="wrap_alert2">
            <div class="alert">내용을 불러오고 있습니다...</div>
        </div>
    </div>
    <div id="alert_area2"></div>
</div>
</div>

<iframe name="sysfrm" id="sysfrm" frameborder="0" width="0" height="0" src=""></iframe>
<script>
let t = {{curr_time}};
let ticTimer = null;
let $timer = $("#timer");
let sendStatus = 0;
let comment = "제한시간이 만료됐습니다.<br id='holder'/> 인증번호를 재발급 받으시기 바랍니다.";
function sendAuthNo(isPass) {
    if(!isPass) {
        if(!confirm("인증번호를 다시 발송합니다. 재발송하시겠습니까?")) return;
    }

    $.getJSON("otpkey_register.jsp?auth2_type=O&mode=send", function(data){
        if(data.status === "-1") {
            showAlert(data.message, "red");
            if(data.curr_time > 0) {
                setTimer(data.curr_time);
            }
        } else if(data.status === "1") {
            showAlert(data.message, "green");
            resetTimer();
        } else if(data.status === "2") {
            $("#container2").hide();
            showAlert(
                "QR코드를 구글OTP에 등록한 후"
                + "<br />[OTP 키 등록하기] 버튼을 눌러주세요."
                + "<br />또는 QR코드 위의 OTP키(영문/숫자)를 '설정 키 입력'에 등록해 주세요."
                + "<br /><a href='https://support.google.com/accounts/answer/1066447?hl=ko&co=GENIE.Platform%3DAndroid' target='_blank'>구글OTP 등록 방법</a>"
                , "green", 2);

            const j = JSON.parse(data.message);
            showBarcode(j.encoded_key, j.barcode_url);
        }
    });
}

function verifyAuthNo() {
    const authNo = $("#auth_no").val();
    if(authNo.length !== 6) {
        showAlert("인증번호를 입력해주세요.", "red");
        return false;
    }
    $.getJSON("otpkey_register.jsp?auth2_type=O&mode=verify&auth_no=" + authNo, function(data){
        if(data.status === "-1") {
            showAlert(data.message, "red");
        } else if(data.status === "-99") {
            alert(data.message);
            history.back();
        } else if(data.status === "1") {
            $("#container2").hide();
            showAlert(
                "QR코드를 구글OTP에 등록한 후"
                + "<br />[OTP 키 등록하기] 버튼을 눌러주세요."
                + "<br />또는 QR코드 위의 OTP키(영문/숫자)를 '설정 키 입력'에 등록해 주세요."
                + "<br /><a href='https://support.google.com/accounts/answer/1066447?hl=ko&co=GENIE.Platform%3DAndroid' target='_blank'>구글OTP 등록 방법</a>"
                , "green", 2);

            const j = JSON.parse(data.message);
            showBarcode(j.encoded_key, j.barcode_url);
        }
    });
}

function showBarcode(key, url) {
    $("#QRUrl")
        .on('load', function() {
            $("#key").html(key);
            $("#key_area").fadeIn("slow", function() {
            });
            stopTimer();
        })
        .attr("src", url);
}

function resetTimer() {
    clearInterval(ticTimer);
    t = {{curr_time}};
    $("#holder").parent().html("제한시간 : <span id='timer'>00:00</span>");
    $timer = $("#timer");
    startTimer();
}

function setTimer(n) {
    t = n;
}

function startTimer() {
    let m = Math.floor(t / 60);
    let s = t % 60;
    $timer.html((m === 0 ? "00" : "0" + m) + ":" + (s === 0 ? "00" : (s < 10) ? "0" + s : s));
    if(t-- === 0) stopTimer();
    ticTimer = tic();
    $("#auth2_verify").attr("disabled", false);
}

function stopTimer() {
    clearInterval(ticTimer);
    $timer.parent().html(comment);
    $("#auth2_verify").attr("disabled", true);
}

function tic() {
    return setInterval(function() {
        let m = Math.floor(t / 60);
        let s = t % 60;
        $timer.html((m === 0 ? "00" : "0" + m) + ":" + (s === 0 ? "00" : (s < 10) ? "0" + s : s));
        if(t-- === 0) stopTimer();
    }, 1000)
}
function showAlert(v, color, n) {
    const wrapId = "#wrap_alert" + (n === 2 ? n : "");
    $(wrapId).show();
    $(wrapId + " > .alert").html(v).removeClass("alert_red").removeClass("alert_green").addClass("alert_" + color);
}

function goAnotherAuth2(t) {
    if(t == 'E'){
        if(confirm("이메일로 인증하시겠습니까?")) parent.location.href = 'auth2.jsp?auth2_type=E&returl={{returl}}';
    } else if(t == 'S'){
        if(confirm("SMS로 인증하시겠습니까?")) parent.location.href = 'auth2.jsp?auth2_type=S&returl={{returl}}';
    }
}

$(function() {
    sendAuthNo(true);
    startTimer();
});
</script>


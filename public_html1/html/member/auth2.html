<style type="text/css">
    * { box-sizing:border-box; font-family: "Malgun Gothic", "맑은 고딕", Arial, Dotum, Gulim; }
    html, body, #container { background-color:#f8f8f8; width:100%; height:auto; text-align:center; }
    #container h3 { padding-top:80px; margin:10px auto; font-size:24px; }

    #auth2 { width:400px; margin:0 auto; background-color:#f5f5f5; border:1px solid #dedede; border-radius:4px; text-align:center; }
    #auth2 #description { padding:20px 0 20px; }

    #auth2 #auth2_box { width:300px; margin:0 auto; }
    #auth2 #auth2_box div { width:100%; display:block; margin:0 auto; }
    <!--@nif(auth2_type:O)-->
    #auth2 #auth2_box div input {  width:70%; text-align:left; margin-top:10px; padding:5px 10px; height:42px; font-size:20px;}
    <!--/nif(auth2_type:O)-->
    <!--@if(auth2_type:O)-->
    #auth2 #auth2_box div input {  width:100%; text-align:left; margin-top:10px; padding:5px 10px; height:42px; font-size:20px;}
    <!--/if(auth2_type:O)-->
    #auth2 #auth2_box button[type=submit] { width:100%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; padding:10px; margin:30px 0; cursor:pointer; }
    #auth2 #auth2_box button[type=button] { width:100%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; padding:10px; margin-bottom: 30px; cursor:pointer; }
    #auth2 #auth2_box button[type=submit]:disabled { background-color:#BFBFBF; border-color:#BFBFBF; }
    #auth2 #auth2_box div button[type=button] { width:25%; background-color:#0d4991; color:#ffffff; font-size:16px; border:1px solid #0d4991; border-radius:4px; text-align:center; margin:10px 0 0 0; padding:7px 10px 5px; height:42px; cursor:pointer;}
    span { display:inline-block; padding-top:10px; font-size:16px; align-content:center; margin-top:5px; }
    #timer { color:red; }

    .alert {background-color:#dedede; color:#000000; border:1px solid #000000; opacity:0.9; font-weight:bold; border-radius:5px; max-width:400px; padding:5px 10px; margin-left:10px; margin-bottom:5px;box-sizing:border-box;}
    .alert_green {background-color:#ecffd5; color:#55aa55; border:1px solid #55aa55;}
    .alert_red {background-color:#f9dfd0; color:#cc0000; border:1px solid #cc0000;}

    #wrap_alert { min-height:50px;display:none;margin-bottom:20px !important; }
    #wrap_alert .alert { margin-bottom:20px;font-size:14px; }

</style>


<div id="container">
    <!--@if(auth2_type:E)-->
    <h3>이메일 2차 인증</h3>
    <!--/if(auth2_type:E)-->
    <!--@if(auth2_type:S)-->
    <h3>SMS 2차 인증</h3>
    <!--/if(auth2_type:S)-->
    <!--@if(auth2_type:O)-->
    <h3>OTP 2차 인증</h3>
    <!--/if(auth2_type:O)-->
    <div id="container2">
        <div id="auth2">
            <div id="description">인증번호를 입력해주세요.</div>
            <div id="auth2_box">
                <form name="form1" method="post" target="sysfrm">
                    <input type="hidden" name="returl" value="{{returl}}">
                    <input type="hidden" name="domain" value="{{domain}}">
                    <input type="hidden" name="session_id" value="{{session_id}}">
                    <input type="hidden" value="check" name="mode">

                    <div>
                        <input tabindex="1" type="text" name="auth_no" id="auth_no" placeholder="인증번호" maxlength="6">
                        <!--@nif(auth2_type:O)-->
                        <button tabindex="2" type="button" onclick="sendAuthNo()">재발송</button>
                        <br/>
                        <span>제한시간 : <span id="timer">00:00</span></span>
                        <!--/nif(auth2_type:O)-->
                    </div>
                    <!--@if(auth2_type:E)-->
                    <div style="margin-top: 20px; text-align: right;">
                        <a href="#" onclick="goAnotherAuth2('S');" style="text-decoration: underline;">SMS로 인증하기</a>&nbsp;
                    </div>
                    <!--/if(auth2_type:E)-->
                    <!--@if(auth2_type:S)-->
                    <div style="margin-top: 20px; text-align: right;">
                        <a href="#" onclick="goAnotherAuth2('E');" style="text-decoration: underline;">이메일로 인증하기</a>&nbsp;
                    </div>
                    <!--/if(auth2_type:S)-->
                    <!--@if(auth2_type:O)-->
                    <div style="margin-top: 20px; text-align: right;">
                        <a href="#" onclick="goAnotherAuth2('E');" style="text-decoration: underline;">이메일로 인증하기</a>&nbsp;&nbsp;&nbsp; <a href="#" onclick="goAnotherAuth2('S');" style="text-decoration: underline;">SMS로 인증하기</a>&nbsp;
                    </div>
                    <!--/if(auth2_type:O)-->
                    <button tabindex="3" id="auth2_submit" type="submit" style="margin-top: 0px; margin-bottom: 30px">인증번호확인</button>
                    <!--@if(auth2_type:O)-->
                    <!--@if(otp_block)-->
                    <button tabindex="4" type="button" onclick="location.href='otpkey_register.jsp?retrul=' + document.forms['form1']['returl'].value">OTP키 다시 확인하러가기</button>
                    <!--/if(otp_block)-->
                    <!--/if(auth2_type:O)-->
                    <button tabindex="5" class="logout" type="button" style="background-color: grey; border-color: grey;" onclick="location.href='logout.jsp'">취소하고 메인페이지로 이동하기</button>

                </form>
                {{form_script}}

                <!--@nif(auth2_type:O)-->
                <div id="wrap_alert">
                    <div class="alert">내용을 불러오고 있습니다...</div>
                </div>
                <!--/nif(auth2_type:O)-->
            </div>
        </div>

    </div>
</div>

<iframe name="sysfrm" id="sysfrm" frameborder="0" width="0" height="0" src=""></iframe>
<!--@nif(auth2_type:O)-->
<script>
    let t = {{curr_time}};
    let ticTimer = null;
    let $timer = $("#timer");
    let sendStatus = 0;
    let auth2Type = "{{auth2_type}}";
    function sendAuthNo(isPass) {
        if(!isPass) {
            if(!confirm("인증번호를 다시 발송합니다. 재발송하시겠습니까?")) return;
        }

        $.getJSON("auth2.jsp?mode=send&auth2_type=" + auth2Type, function(data){
            if(data.status === "-1") {
                showAlert(data.message, "red");
                if(data.curr_time > 0) {
                    setTimer(data.curr_time);
                }
            } else if(data.status === "1") {
                showAlert(data.message, "green");
                resetTimer();
            }
        });
    }

    function resetTimer() {
        clearInterval(ticTimer);
        t = {{curr_time}};
        $("#holder").parent().html("제한시간 : <span id='timer'>00:00</span>");
        $timer = $("#timer");
        startTimer();
    }

    function setTimer(n) {
        t = n;
    }

    function startTimer() {
        let m = Math.floor(t / 60);
        let s = t % 60;
        $timer.html((m === 0 ? "00" : "0" + m) + ":" + (s === 0 ? "00" : (s < 10) ? "0" + s : s));
        if(t-- === 0) stopTimer();
        ticTimer = tic();
        $("#auth2_submit").attr("disabled", false);
    }

    function stopTimer() {
        clearInterval(ticTimer);
        $timer.parent().html("제한시간이 만료됐습니다.<br id='holder'/> 인증번호를 재발급 받으시기 바랍니다.");
        $("#auth2_submit").attr("disabled", true);
    }

    function tic() {
        return setInterval(function() {
            let m = Math.floor(t / 60);
            let s = t % 60;
            $timer.html((m === 0 ? "00" : "0" + m) + ":" + (s === 0 ? "00" : (s < 10) ? "0" + s : s));
            if(t-- === 0) stopTimer();
        }, 1000)
    }

    function showAlert(v, color) {
        $("#wrap-alert").show();
        $(".alert").html(v).removeClass("alert_red").removeClass("alert_green").addClass("alert_" + color);
    }

    $(function() {
        sendAuthNo(true);
        startTimer();
    });

</script>

<!--/nif(auth2_type:O)-->

<script>
    function goAnotherAuth2(t) {
        if(t == 'E'){ if(confirm("이메일로 인증하시겠습니까?")) parent.location.href = 'auth2.jsp?auth2_type=E&returl={{returl}}'; }
        else if(t == 'S'){ if(confirm("SMS로 인증하시겠습니까?")) parent.location.href = 'auth2.jsp?auth2_type=S&returl={{returl}}'; }
        //else if(t == 'O'){ if(confirm("OTP로 인증하시겠습니까?")) parent.location.href = 'auth2.jsp?auth2_type=O&returl={{returl}}'; }
    }
</script>